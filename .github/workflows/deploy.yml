name: è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

on:
  push:
    branches:
      - master # å½“æ¨é€åˆ°masteråˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            # æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin master

            # ã€é›¶åœæœºéƒ¨ç½²ã€‘å…ˆæ„å»ºæ–°é•œåƒï¼ˆæ—§å®¹å™¨ç»§ç»­è¿è¡Œï¼‰
            echo "ğŸ”¨ æ„å»ºæ–°é•œåƒ..."
            docker-compose build

            # å¿«é€Ÿåˆ‡æ¢ï¼šåœæ­¢æ—§å®¹å™¨å¹¶ç«‹å³å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸ”„ åˆ‡æ¢åˆ°æ–°å®¹å™¨..."
            docker-compose down --remove-orphans || true
            docker rm -f $(docker ps -aq --filter "name=data_processing") 2>/dev/null || true
            docker-compose up -d

            # æ¸…ç†æ— ç”¨é•œåƒå’Œå®¹å™¨
            docker image prune -f
            docker container prune -f

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
