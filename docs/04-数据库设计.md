# 数据库设计

## 1. 数据库概览

### 1.1 技术选型

| 组件       | 技术         | 说明                   |
| ---------- | ------------ | ---------------------- |
| ORM        | Prisma 6.2.1 | 类型安全的数据库访问层 |
| 开发数据库 | SQLite       | 轻量级，无需配置       |
| 生产数据库 | PostgreSQL   | 高性能，适合生产环境   |

### 1.2 配置文件位置

```
prisma/
├── schema.prisma          # 数据库Schema定义
├── migrations/            # 数据库迁移记录
│   ├── 20260108014651_init/
│   │   └── migration.sql
│   └── migration_lock.toml
└── dev.db                 # SQLite开发数据库文件
```

---

## 2. Prisma Schema

### 2.1 完整Schema定义

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"  // 生产环境改为 "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 用户认证模型 ====================

/// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  avatar    String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  sessions      Session[]
  uploadedFiles UploadedFile[]
  reports       Report[]

  @@index([email])
  @@map("users")
}

/// 用户角色枚举
enum Role {
  USER
  ADMIN
}

/// 会话表
model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// ==================== 文件管理模型 ====================

/// 上传文件表
model UploadedFile {
  id        String     @id @default(cuid())
  name      String     // 原始文件名
  path      String     // 存储路径
  size      Int        // 文件大小(bytes)
  mimeType  String     // MIME类型
  userId    String
  status    FileStatus @default(PENDING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // 关联关系
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysisResults AnalysisResult[]
  reports         Report[]

  @@index([userId])
  @@index([status])
  @@map("uploaded_files")
}

/// 文件状态枚举
enum FileStatus {
  PENDING     // 待处理
  PROCESSING  // 处理中
  COMPLETED   // 已完成
  FAILED      // 处理失败
}

// ==================== 分析结果模型 ====================

/// 分析结果表
model AnalysisResult {
  id         String   @id @default(cuid())
  fileId     String
  type       String   // 分析类型
  data       String   // JSON格式的分析数据
  stats      String   // JSON格式的统计信息
  insights   String?  // JSON格式的洞察
  createdAt  DateTime @default(now())

  // 关联关系
  file UploadedFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@map("analysis_results")
}

// ==================== 报告模型 ====================

/// 报告表
model Report {
  id         String       @id @default(cuid())
  name       String       // 报告名称
  type       ReportType   // 报告类型
  path       String       // 报告文件路径
  fileId     String       // 源文件ID
  userId     String       // 创建者ID
  status     ReportStatus @default(PENDING)
  metadata   String?      // JSON格式的元数据
  createdAt  DateTime     @default(now())
  completedAt DateTime?

  // 关联关系
  file UploadedFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([userId])
  @@index([status])
  @@map("reports")
}

/// 报告类型枚举
enum ReportType {
  DOCX  // Word文档
  PPTX  // PPT演示
  PDF   // PDF文档
}

/// 报告状态枚举
enum ReportStatus {
  PENDING     // 待生成
  GENERATING  // 生成中
  COMPLETED   // 已完成
  FAILED      // 生成失败
}
```

---

## 3. 数据模型详解

### 3.1 User (用户模型)

**用途**: 存储用户账户信息

| 字段      | 类型     | 约束          | 说明         |
| --------- | -------- | ------------- | ------------ |
| id        | String   | PK, CUID      | 用户唯一标识 |
| email     | String   | Unique        | 邮箱地址     |
| name      | String?  | Optional      | 用户名       |
| password  | String   | Required      | 加密后的密码 |
| avatar    | String?  | Optional      | 头像URL      |
| role      | Role     | Default(USER) | 用户角色     |
| createdAt | DateTime | Default(now)  | 创建时间     |
| updatedAt | DateTime | Auto          | 更新时间     |

**关联关系**:

- 一对多: `sessions` - 用户会话
- 一对多: `uploadedFiles` - 上传的文件
- 一对多: `reports` - 生成的报告

**索引**:

- `email` - 加速登录查询

### 3.2 Session (会话模型)

**用途**: 管理用户登录会话

| 字段      | 类型     | 约束         | 说明         |
| --------- | -------- | ------------ | ------------ |
| id        | String   | PK, CUID     | 会话唯一标识 |
| token     | String   | Unique       | JWT令牌      |
| userId    | String   | FK           | 关联用户ID   |
| expiresAt | DateTime | Required     | 过期时间     |
| createdAt | DateTime | Default(now) | 创建时间     |

**关联关系**:

- 多对一: `user` - 所属用户 (级联删除)

### 3.3 UploadedFile (上传文件模型)

**用途**: 记录用户上传的Excel文件

| 字段      | 类型       | 约束             | 说明           |
| --------- | ---------- | ---------------- | -------------- |
| id        | String     | PK, CUID         | 文件唯一标识   |
| name      | String     | Required         | 原始文件名     |
| path      | String     | Required         | 服务器存储路径 |
| size      | Int        | Required         | 文件大小(字节) |
| mimeType  | String     | Required         | MIME类型       |
| userId    | String     | FK               | 上传用户ID     |
| status    | FileStatus | Default(PENDING) | 处理状态       |
| createdAt | DateTime   | Default(now)     | 上传时间       |
| updatedAt | DateTime   | Auto             | 更新时间       |

**关联关系**:

- 多对一: `user` - 上传者
- 一对多: `analysisResults` - 分析结果
- 一对多: `reports` - 生成的报告

### 3.4 AnalysisResult (分析结果模型)

**用途**: 存储Excel数据分析结果

| 字段      | 类型     | 约束         | 说明             |
| --------- | -------- | ------------ | ---------------- |
| id        | String   | PK, CUID     | 结果唯一标识     |
| fileId    | String   | FK           | 关联文件ID       |
| type      | String   | Required     | 分析类型         |
| data      | String   | Required     | JSON格式分析数据 |
| stats     | String   | Required     | JSON格式统计信息 |
| insights  | String?  | Optional     | JSON格式洞察     |
| createdAt | DateTime | Default(now) | 创建时间         |

**data字段结构示例**:

```json
{
  "sheets": [
    {
      "name": "Sheet1",
      "columns": ["Sample", "Type", "Result"],
      "rowCount": 100,
      "preview": [...]
    }
  ],
  "mutations": {
    "WT": 30,
    "HET": 45,
    "HOM": 25
  }
}
```

### 3.5 Report (报告模型)

**用途**: 记录生成的分析报告

| 字段        | 类型         | 约束             | 说明                    |
| ----------- | ------------ | ---------------- | ----------------------- |
| id          | String       | PK, CUID         | 报告唯一标识            |
| name        | String       | Required         | 报告名称                |
| type        | ReportType   | Required         | 报告类型(DOCX/PPTX/PDF) |
| path        | String       | Required         | 报告文件路径            |
| fileId      | String       | FK               | 源文件ID                |
| userId      | String       | FK               | 创建者ID                |
| status      | ReportStatus | Default(PENDING) | 生成状态                |
| metadata    | String?      | Optional         | JSON格式元数据          |
| createdAt   | DateTime     | Default(now)     | 创建时间                |
| completedAt | DateTime?    | Optional         | 完成时间                |

---

## 4. 枚举类型

### 4.1 Role (用户角色)

```prisma
enum Role {
  USER   // 普通用户
  ADMIN  // 管理员
}
```

### 4.2 FileStatus (文件状态)

```prisma
enum FileStatus {
  PENDING     // 待处理 - 文件刚上传
  PROCESSING  // 处理中 - 正在解析分析
  COMPLETED   // 已完成 - 处理成功
  FAILED      // 处理失败 - 出现错误
}
```

### 4.3 ReportType (报告类型)

```prisma
enum ReportType {
  DOCX  // Word文档
  PPTX  // PowerPoint演示
  PDF   // PDF文档
}
```

### 4.4 ReportStatus (报告状态)

```prisma
enum ReportStatus {
  PENDING     // 待生成
  GENERATING  // 生成中
  COMPLETED   // 已完成
  FAILED      // 生成失败
}
```

---

## 5. 数据库关系图

```
┌─────────────┐       ┌─────────────┐
│    User     │       │   Session   │
├─────────────┤       ├─────────────┤
│ id (PK)     │◄──────┤ userId (FK) │
│ email       │   1:N │ token       │
│ name        │       │ expiresAt   │
│ password    │       └─────────────┘
│ role        │
└──────┬──────┘
       │
       │ 1:N
       ▼
┌─────────────────┐
│  UploadedFile   │
├─────────────────┤
│ id (PK)         │◄──────────────────┐
│ userId (FK)     │                   │
│ name            │                   │
│ path            │                   │
│ status          │                   │
└────────┬────────┘                   │
         │                            │
    ┌────┴────┐                       │
    │ 1:N     │ 1:N                   │
    ▼         ▼                       │
┌────────────┐  ┌─────────────┐       │
│AnalysisResult│ │   Report    │       │
├────────────┤  ├─────────────┤       │
│ id (PK)    │  │ id (PK)     │       │
│ fileId(FK) │  │ fileId (FK) │───────┘
│ type       │  │ userId (FK) │───────┐
│ data       │  │ type        │       │
│ stats      │  │ path        │       │
└────────────┘  │ status      │       │
                └─────────────┘       │
                       ▲              │
                       │ N:1          │
                       └──────────────┘
                         User关联
```

---

## 6. Prisma Client 使用

### 6.1 初始化客户端

```typescript
// src/lib/prisma.ts
import { PrismaClient } from "@prisma/client";

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log:
      process.env.NODE_ENV === "development"
        ? ["query", "error", "warn"]
        : ["error"],
  });

if (process.env.NODE_ENV !== "production") {
  globalForPrisma.prisma = prisma;
}
```

### 6.2 常用查询示例

#### 用户认证

```typescript
// 用户注册
const user = await prisma.user.create({
  data: {
    email: "user@example.com",
    name: "Test User",
    password: hashedPassword,
  },
});

// 用户登录查询
const user = await prisma.user.findUnique({
  where: { email: "user@example.com" },
  include: { sessions: true },
});

// 创建会话
const session = await prisma.session.create({
  data: {
    token: jwtToken,
    userId: user.id,
    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
  },
});
```

#### 文件操作

```typescript
// 记录上传文件
const file = await prisma.uploadedFile.create({
  data: {
    name: "data.xlsx",
    path: "/uploads/user123/abc.xlsx",
    size: 102400,
    mimeType:
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    userId: user.id,
  },
});

// 更新文件状态
await prisma.uploadedFile.update({
  where: { id: fileId },
  data: { status: "COMPLETED" },
});

// 查询用户文件列表
const files = await prisma.uploadedFile.findMany({
  where: {
    userId: user.id,
    status: "COMPLETED",
  },
  orderBy: { createdAt: "desc" },
  take: 20,
});
```

#### 分析结果

```typescript
// 保存分析结果
const result = await prisma.analysisResult.create({
  data: {
    fileId: file.id,
    type: "gene_editing",
    data: JSON.stringify(analysisData),
    stats: JSON.stringify(statsData),
    insights: JSON.stringify(insights),
  },
});

// 查询文件的分析结果
const results = await prisma.analysisResult.findMany({
  where: { fileId: file.id },
  orderBy: { createdAt: "desc" },
});
```

#### 报告操作

```typescript
// 创建报告记录
const report = await prisma.report.create({
  data: {
    name: "基因编辑分析报告",
    type: "DOCX",
    path: "/reports/report_123.docx",
    fileId: file.id,
    userId: user.id,
    status: "GENERATING",
  },
});

// 更新报告状态
await prisma.report.update({
  where: { id: report.id },
  data: {
    status: "COMPLETED",
    completedAt: new Date(),
  },
});

// 查询用户报告
const reports = await prisma.report.findMany({
  where: { userId: user.id },
  include: {
    file: { select: { name: true } },
  },
  orderBy: { createdAt: "desc" },
});
```

### 6.3 事务处理

```typescript
// 创建文件并记录分析结果（事务）
const result = await prisma.$transaction(async (tx) => {
  // 创建文件记录
  const file = await tx.uploadedFile.create({
    data: {
      name: "data.xlsx",
      path: filePath,
      size: fileSize,
      mimeType:
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      userId: userId,
      status: "PROCESSING",
    },
  });

  // 保存分析结果
  const analysis = await tx.analysisResult.create({
    data: {
      fileId: file.id,
      type: "initial",
      data: JSON.stringify(initialData),
      stats: JSON.stringify({}),
    },
  });

  // 更新文件状态
  await tx.uploadedFile.update({
    where: { id: file.id },
    data: { status: "COMPLETED" },
  });

  return { file, analysis };
});
```

---

## 7. 数据库迁移

### 7.1 迁移命令

```bash
# 创建迁移
npx prisma migrate dev --name <migration_name>

# 应用迁移（生产环境）
npx prisma migrate deploy

# 重置数据库（开发环境）
npx prisma migrate reset

# 生成Prisma Client
npx prisma generate

# 查看数据库
npx prisma studio
```

### 7.2 初始迁移SQL

```sql
-- prisma/migrations/20260108014651_init/migration.sql

-- CreateTable
CREATE TABLE "users" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "email" TEXT NOT NULL,
    "name" TEXT,
    "password" TEXT NOT NULL,
    "avatar" TEXT,
    "role" TEXT NOT NULL DEFAULT 'USER',
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL
);

-- CreateTable
CREATE TABLE "sessions" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "token" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "expiresAt" DATETIME NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "sessions_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "uploaded_files" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL,
    "path" TEXT NOT NULL,
    "size" INTEGER NOT NULL,
    "mimeType" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'PENDING',
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL,
    CONSTRAINT "uploaded_files_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "analysis_results" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "fileId" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "data" TEXT NOT NULL,
    "stats" TEXT NOT NULL,
    "insights" TEXT,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "analysis_results_fileId_fkey" FOREIGN KEY ("fileId") REFERENCES "uploaded_files" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateTable
CREATE TABLE "reports" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "path" TEXT NOT NULL,
    "fileId" TEXT NOT NULL,
    "userId" TEXT NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'PENDING',
    "metadata" TEXT,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "completedAt" DATETIME,
    CONSTRAINT "reports_fileId_fkey" FOREIGN KEY ("fileId") REFERENCES "uploaded_files" ("id") ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT "reports_userId_fkey" FOREIGN KEY ("userId") REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE
);

-- CreateIndex
CREATE UNIQUE INDEX "users_email_key" ON "users"("email");
CREATE INDEX "users_email_idx" ON "users"("email");
CREATE UNIQUE INDEX "sessions_token_key" ON "sessions"("token");
CREATE INDEX "sessions_token_idx" ON "sessions"("token");
CREATE INDEX "sessions_userId_idx" ON "sessions"("userId");
CREATE INDEX "uploaded_files_userId_idx" ON "uploaded_files"("userId");
CREATE INDEX "uploaded_files_status_idx" ON "uploaded_files"("status");
CREATE INDEX "analysis_results_fileId_idx" ON "analysis_results"("fileId");
CREATE INDEX "reports_fileId_idx" ON "reports"("fileId");
CREATE INDEX "reports_userId_idx" ON "reports"("userId");
CREATE INDEX "reports_status_idx" ON "reports"("status");
```

---

## 8. 生产环境配置

### 8.1 PostgreSQL配置

修改 `prisma/schema.prisma`:

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

### 8.2 环境变量

```bash
# 开发环境 (SQLite)
DATABASE_URL="file:./dev.db"

# 生产环境 (PostgreSQL)
DATABASE_URL="postgresql://user:password@localhost:5432/data_processing?schema=public"
```

### 8.3 连接池配置

```typescript
// 生产环境Prisma配置
export const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL,
    },
  },
  log: ["error"],
});
```

---

## 9. 相关文档

| 文档                                        | 描述           |
| ------------------------------------------- | -------------- |
| [01-项目概述与架构](./01-项目概述与架构.md) | 项目整体架构   |
| [03-后端服务详解](./03-后端服务详解.md)     | 后端API实现    |
| [06-部署与配置](./06-部署与配置.md)         | 数据库部署配置 |

---

_文档版本: 1.0.0 | 更新时间: 2026-02-10_
