# 部署与配置

## 1. 部署概览

### 1.1 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Host                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   Next.js App   │    │  Python Service │                │
│  │   (Port 3000)   │◄──►│   (Port 8000)   │                │
│  └────────┬────────┘    └────────┬────────┘                │
│           │                      │                          │
│           └──────────┬───────────┘                          │
│                      ▼                                      │
│           ┌─────────────────────┐                          │
│           │   Shared Volumes    │                          │
│           │  - uploads/         │                          │
│           │  - reports/         │                          │
│           │  - prisma/          │                          │
│           └─────────────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   Nginx     │
                    │ (可选反向代理)│
                    └─────────────┘
```

### 1.2 部署方式

| 方式           | 适用场景           | 复杂度 |
| -------------- | ------------------ | ------ |
| Docker Compose | 单机部署、开发测试 | 低     |
| 1Panel面板     | 可视化管理部署     | 低     |
| Kubernetes     | 大规模生产环境     | 高     |
| 手动部署       | 自定义环境         | 中     |

---

## 2. Docker 部署

### 2.1 Dockerfile (Next.js)

```dockerfile
# Dockerfile
FROM node:18-alpine AS base

# 依赖安装阶段
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

COPY package.json package-lock.json* ./
RUN npm ci

# 构建阶段
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Prisma生成
RUN npx prisma generate

# 构建Next.js
ENV NEXT_TELEMETRY_DISABLED 1
RUN npm run build

# 生产运行阶段
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# 复制必要文件
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# 创建数据目录
RUN mkdir -p uploads reports prisma
RUN chown -R nextjs:nodejs uploads reports prisma

# 启动脚本
COPY docker-entrypoint.sh ./
RUN chmod +x docker-entrypoint.sh

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

ENTRYPOINT ["./docker-entrypoint.sh"]
CMD ["node", "server.js"]
```

### 2.2 Dockerfile (Python服务)

```dockerfile
# python_service/Dockerfile
FROM python:3.10-slim

WORKDIR /app

# 系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/*

# Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 应用代码
COPY . .

# 创建目录
RUN mkdir -p reports uploads

# 非root用户
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2.3 Docker Compose

```yaml
# docker-compose.yml
version: "3.8"

services:
  # Next.js前端应用
  nextjs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: data-analysis-nextjs
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/prisma/dev.db
      - PYTHON_SERVICE_URL=http://python-service:8000
      - JWT_SECRET=${JWT_SECRET:-your-jwt-secret-here}
    volumes:
      - ./uploads:/app/uploads
      - ./prisma:/app/prisma
      - ./python_service/reports:/app/reports
    depends_on:
      - python-service
    restart: unless-stopped
    networks:
      - app-network

  # Python后端服务
  python-service:
    build:
      context: ./python_service
      dockerfile: Dockerfile
    container_name: data-analysis-python
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - QWEN_MODEL=${QWEN_MODEL:-qwen-max}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
    volumes:
      - ./uploads:/app/uploads
      - ./python_service/reports:/app/reports
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  uploads:
  reports:
  prisma:
```

### 2.4 启动脚本

```bash
#!/bin/sh
# docker-entrypoint.sh

set -e

echo "Running database migrations..."
npx prisma migrate deploy

echo "Starting Next.js server..."
exec "$@"
```

### 2.5 部署命令

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart

# 清理并重建
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d
```

---

## 3. 环境变量配置

### 3.1 完整环境变量列表

```bash
# env.production.template

# ==================== 应用配置 ====================
NODE_ENV=production
PORT=3000

# ==================== 数据库配置 ====================
# SQLite (开发/小规模部署)
DATABASE_URL="file:./prisma/dev.db"

# PostgreSQL (生产环境)
# DATABASE_URL="postgresql://user:password@localhost:5432/data_processing?schema=public"

# ==================== 认证配置 ====================
JWT_SECRET=your-super-secret-jwt-key-at-least-32-characters
JWT_EXPIRES_IN=7d

# ==================== Python服务配置 ====================
PYTHON_SERVICE_URL=http://python-service:8000
# 或本地开发: PYTHON_SERVICE_URL=http://localhost:8000

# ==================== OpenAI配置 ====================
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4

# ==================== 通义千问配置 (可选) ====================
DASHSCOPE_API_KEY=sk-your-dashscope-key
QWEN_MODEL=qwen-max

# ==================== LLM通用配置 ====================
LLM_PROVIDER=openai
# 可选值: openai, qwen

# ==================== 文件存储配置 ====================
UPLOAD_DIR=./uploads
REPORT_DIR=./reports
MAX_FILE_SIZE=52428800

# ==================== 日志配置 ====================
LOG_LEVEL=info
# 可选值: debug, info, warn, error
```

### 3.2 环境变量说明

| 变量                 | 必需 | 默认值                    | 说明                 |
| -------------------- | ---- | ------------------------- | -------------------- |
| `NODE_ENV`           | 是   | development               | 运行环境             |
| `DATABASE_URL`       | 是   | -                         | 数据库连接字符串     |
| `JWT_SECRET`         | 是   | -                         | JWT签名密钥(≥32字符) |
| `PYTHON_SERVICE_URL` | 是   | -                         | Python服务地址       |
| `OPENAI_API_KEY`     | 是\* | -                         | OpenAI API密钥       |
| `OPENAI_BASE_URL`    | 否   | https://api.openai.com/v1 | OpenAI API地址       |
| `OPENAI_MODEL`       | 否   | gpt-4                     | 使用的模型           |
| `LLM_PROVIDER`       | 否   | openai                    | LLM提供商            |

\*如果使用通义千问，则`DASHSCOPE_API_KEY`必需

### 3.3 创建环境文件

```bash
# 复制模板
cp env.production.template .env.production

# 编辑配置
nano .env.production

# 或使用vi
vi .env.production
```

---

## 4. 1Panel 面板部署

### 4.1 部署步骤

详见项目根目录的 `DEPLOY_1PANEL.md` 文件。

**基本流程:**

1. **安装1Panel面板**

```bash
curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh -o quick_start.sh && sudo bash quick_start.sh
```

2. **登录面板** → 访问 `http://服务器IP:面板端口`

3. **安装Docker应用运行环境**
   - 应用商店 → 搜索 "Docker" → 安装

4. **上传项目文件**
   - 文件管理 → 上传项目到 `/opt/data-analysis-agent`

5. **创建容器**
   - 容器 → Compose → 新建
   - 选择项目目录，使用 `docker-compose.yml`

6. **配置环境变量**
   - 编辑 `.env.production` 文件
   - 设置必要的API密钥

7. **启动服务**
   - 点击"启动"按钮

### 4.2 1Panel优势

- 可视化管理界面
- 一键SSL证书申请
- 内置Nginx反向代理
- 容器日志实时查看
- 资源监控面板

---

## 5. 手动部署

### 5.1 系统要求

- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **Node.js**: 18.0.0+
- **Python**: 3.10+
- **内存**: 4GB+ 推荐
- **存储**: 10GB+ 推荐

### 5.2 安装依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y nodejs npm python3 python3-pip python3-venv

# CentOS/RHEL
sudo yum install -y nodejs npm python3 python3-pip
```

### 5.3 部署Next.js应用

```bash
# 克隆项目
git clone <repository-url>
cd data_processing

# 安装依赖
npm install

# 配置环境变量
cp env.production.template .env.production
# 编辑 .env.production

# 生成Prisma客户端
npx prisma generate

# 执行数据库迁移
npx prisma migrate deploy

# 构建应用
npm run build

# 启动应用
npm start
# 或使用PM2
pm2 start npm --name "data-analysis" -- start
```

### 5.4 部署Python服务

```bash
# 进入Python服务目录
cd python_service

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 启动服务
uvicorn main:app --host 0.0.0.0 --port 8000

# 或使用Gunicorn (生产推荐)
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
```

### 5.5 PM2进程管理

```bash
# 安装PM2
npm install -g pm2

# 启动Next.js
pm2 start npm --name "nextjs-app" -- start

# 启动Python服务
pm2 start "uvicorn main:app --host 0.0.0.0 --port 8000" --name "python-service" --cwd ./python_service

# 保存进程列表
pm2 save

# 开机自启
pm2 startup

# 查看状态
pm2 status

# 查看日志
pm2 logs
```

---

## 6. Nginx 反向代理

### 6.1 配置文件

```nginx
# /etc/nginx/sites-available/data-analysis-agent
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL证书
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # 文件上传大小限制
    client_max_body_size 50M;

    # Next.js应用
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Python API服务 (可选直接暴露)
    location /python-api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 静态文件缓存
    location /_next/static {
        proxy_pass http://127.0.0.1:3000;
        proxy_cache_valid 60m;
        add_header Cache-Control "public, immutable";
    }

    # 上传文件访问
    location /uploads {
        alias /opt/data-analysis-agent/uploads;
        expires 1d;
    }

    # 报告下载
    location /reports {
        alias /opt/data-analysis-agent/python_service/reports;
        expires 1h;
    }
}
```

### 6.2 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/data-analysis-agent /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 6.3 SSL证书 (Let's Encrypt)

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

---

## 7. 数据库配置

### 7.1 SQLite (开发/小规模)

```bash
# 环境变量
DATABASE_URL="file:./prisma/dev.db"

# 初始化
npx prisma migrate deploy
```

### 7.2 PostgreSQL (生产推荐)

```bash
# 安装PostgreSQL
sudo apt install postgresql postgresql-contrib

# 创建用户和数据库
sudo -u postgres psql
CREATE USER datauser WITH PASSWORD 'your-password';
CREATE DATABASE data_processing OWNER datauser;
GRANT ALL PRIVILEGES ON DATABASE data_processing TO datauser;
\q

# 环境变量
DATABASE_URL="postgresql://datauser:your-password@localhost:5432/data_processing?schema=public"

# 修改prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

# 重新生成客户端并迁移
npx prisma generate
npx prisma migrate deploy
```

---

## 8. 监控与日志

### 8.1 日志配置

```bash
# Next.js日志
# 使用PM2时自动管理
pm2 logs nextjs-app

# Python服务日志
tail -f python_service/app.log

# Docker日志
docker-compose logs -f
docker logs -f data-analysis-nextjs
docker logs -f data-analysis-python
```

### 8.2 健康检查

```bash
# Next.js健康检查
curl http://localhost:3000/api/health

# Python服务健康检查
curl http://localhost:8000/health

# Docker健康检查 (docker-compose.yml添加)
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

### 8.3 资源监控

```bash
# Docker资源使用
docker stats

# 系统资源
htop
# 或
top

# 磁盘使用
df -h
du -sh uploads/ reports/
```

---

## 9. 备份与恢复

### 9.1 备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
PROJECT_DIR="/opt/data-analysis-agent"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp $PROJECT_DIR/prisma/dev.db $BACKUP_DIR/db_$DATE.db

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz -C $PROJECT_DIR uploads/

# 备份报告
tar -czf $BACKUP_DIR/reports_$DATE.tar.gz -C $PROJECT_DIR/python_service reports/

# 清理7天前的备份
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
```

### 9.2 定时备份

```bash
# 添加crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /opt/scripts/backup.sh >> /var/log/backup.log 2>&1
```

### 9.3 恢复数据

```bash
# 恢复数据库
cp /opt/backups/db_20260210.db /opt/data-analysis-agent/prisma/dev.db

# 恢复上传文件
tar -xzf /opt/backups/uploads_20260210.tar.gz -C /opt/data-analysis-agent/

# 恢复报告
tar -xzf /opt/backups/reports_20260210.tar.gz -C /opt/data-analysis-agent/python_service/
```

---

## 10. 故障排查

### 10.1 常见问题

| 问题           | 可能原因         | 解决方案                       |
| -------------- | ---------------- | ------------------------------ |
| 服务启动失败   | 端口占用         | `lsof -i :3000` 检查并释放端口 |
| 数据库连接失败 | DATABASE_URL错误 | 检查环境变量和数据库状态       |
| AI生成失败     | API密钥无效      | 验证OPENAI_API_KEY             |
| 文件上传失败   | 目录权限         | `chmod 755 uploads/`           |
| 内存溢出       | 内存不足         | 增加服务器内存或优化配置       |

### 10.2 调试命令

```bash
# 检查服务状态
systemctl status nginx
pm2 status
docker-compose ps

# 检查端口
netstat -tlnp | grep -E '3000|8000'

# 检查日志
tail -100 /var/log/nginx/error.log
pm2 logs --lines 100

# 测试API
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'

# 检查磁盘空间
df -h
```

---

## 11. 安全建议

### 11.1 基础安全

- 使用强密码的JWT_SECRET (≥32字符随机字符串)
- 定期更新依赖包
- 启用HTTPS
- 限制文件上传大小和类型
- 配置防火墙规则

### 11.2 生产环境检查清单

- [ ] 环境变量不包含敏感信息的默认值
- [ ] 数据库使用强密码
- [ ] 启用SSL/TLS
- [ ] 配置Nginx安全头
- [ ] 设置适当的CORS策略
- [ ] 启用日志审计
- [ ] 配置自动备份
- [ ] 设置资源限制

---

## 12. 相关文档

| 文档                                        | 描述           |
| ------------------------------------------- | -------------- |
| [01-项目概述与架构](./01-项目概述与架构.md) | 项目整体架构   |
| [DEPLOY_GUIDE.md](../DEPLOY_GUIDE.md)       | 简化部署指南   |
| [DEPLOY_1PANEL.md](../DEPLOY_1PANEL.md)     | 1Panel部署指南 |

---

_文档版本: 1.0.0 | 更新时间: 2026-02-10_
