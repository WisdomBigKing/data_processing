# GitHub 自动部署指南

本文档说明如何配置 GitHub Actions，实现推送代码后自动部署到你的 Linux 服务器。

## 架构说明

```
开发电脑 → git push → GitHub → GitHub Actions → SSH → 服务器 → docker-compose up
```

---

## 第一步：服务器准备

### 1.1 安装必要软件

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh
systemctl enable docker
systemctl start docker

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 安装 Git
apt update && apt install -y git
```

### 1.2 克隆项目到服务器

```bash
# 创建项目目录
mkdir -p /opt/data_processing
cd /opt/data_processing

# 克隆项目（首次部署）
git clone https://github.com/你的用户名/data_processing.git .

# 或者如果是私有仓库，使用 SSH
git clone git@github.com:你的用户名/data_processing.git .
```

### 1.3 创建环境配置文件

```bash
# 复制模板
cp env.production.template .env

# 编辑配置
nano .env
```

修改以下配置：

```env
# 必须修改
JWT_SECRET=你的随机密钥（至少32位）
NEXT_PUBLIC_APP_URL=http://你的服务器IP:3000

# LLM配置
LLM_API_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_API_KEY=你的阿里云API密钥
LLM_MODEL=qwen-flash-2025-07-28
```

### 1.4 生成 SSH 密钥（用于 GitHub Actions）

```bash
# 在服务器上生成密钥对
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/github_actions -N ""

# 将公钥添加到 authorized_keys
cat ~/.ssh/github_actions.pub >> ~/.ssh/authorized_keys

# 查看私钥（需要复制到 GitHub Secrets）
cat ~/.ssh/github_actions
```

---

## 第二步：配置 GitHub Secrets

在 GitHub 仓库中配置以下 Secrets：

1. 打开你的 GitHub 仓库
2. 点击 **Settings** → **Secrets and variables** → **Actions**
3. 点击 **New repository secret**，添加以下变量：

| Secret 名称      | 值                     | 说明                         |
| ---------------- | ---------------------- | ---------------------------- |
| `SERVER_HOST`    | `你的服务器IP`         | 服务器公网IP地址             |
| `SERVER_USER`    | `root`                 | SSH登录用户名                |
| `SERVER_PORT`    | `22`                   | SSH端口（默认22）            |
| `SERVER_SSH_KEY` | `私钥内容`             | 上一步生成的私钥（完整内容） |
| `DEPLOY_PATH`    | `/opt/data_processing` | 服务器上的项目路径           |

### 私钥格式示例

```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
...（中间内容）...
QyBrZXkAAAAA
-----END OPENSSH PRIVATE KEY-----
```

> **注意**：复制完整的私钥内容，包括开头和结尾的 `-----BEGIN...` 和 `-----END...`

---

## 第三步：首次部署

在服务器上手动执行首次部署：

```bash
cd /opt/data_processing

# 构建并启动
docker-compose up -d --build

# 查看日志
docker-compose logs -f
```

访问 `http://你的服务器IP:3000` 验证部署成功。

---

## 第四步：自动部署测试

### 4.1 推送代码触发部署

```bash
# 在本地开发环境
git add .
git commit -m "测试自动部署"
git push origin main
```

### 4.2 查看部署状态

1. 打开 GitHub 仓库
2. 点击 **Actions** 标签
3. 查看最新的工作流运行状态

### 4.3 手动触发部署

1. 打开 GitHub 仓库 → **Actions**
2. 选择 **自动部署到服务器** 工作流
3. 点击 **Run workflow** → **Run workflow**

---

## 工作流配置说明

文件位置：`.github/workflows/deploy.yml`

```yaml
name: 自动部署到服务器

on:
  push:
    branches:
      - main # 当推送到main分支时触发
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 部署到服务器
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            git pull origin main
            docker-compose down
            docker-compose up -d --build
            docker image prune -f
```

---

## 高级配置

### 只在特定文件变更时部署

```yaml
on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "python_service/**"
      - "docker-compose.yml"
      - "Dockerfile"
```

### 添加部署通知（钉钉/企业微信）

```yaml
- name: 发送部署通知
  if: always()
  run: |
    curl -X POST "你的Webhook地址" \
      -H "Content-Type: application/json" \
      -d '{"msgtype": "text", "text": {"content": "部署完成: ${{ job.status }}"}}'
```

### 添加健康检查

```yaml
- name: 健康检查
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.SERVER_HOST }}
    username: ${{ secrets.SERVER_USER }}
    key: ${{ secrets.SERVER_SSH_KEY }}
    port: ${{ secrets.SERVER_PORT }}
    script: |
      sleep 30  # 等待服务启动
      curl -f http://localhost:3000 || exit 1
      echo "✅ 健康检查通过"
```

---

## 故障排除

### 问题：SSH 连接失败

检查：

1. 服务器防火墙是否开放 SSH 端口
2. `SERVER_SSH_KEY` 是否正确（包含完整的私钥）
3. 公钥是否已添加到服务器的 `~/.ssh/authorized_keys`

```bash
# 在服务器上检查
cat ~/.ssh/authorized_keys
```

### 问题：git pull 失败

检查：

1. 服务器是否有 Git 权限
2. 如果是私有仓库，需要配置 Deploy Key

```bash
# 添加 GitHub Deploy Key
cat ~/.ssh/github_actions.pub
# 将公钥添加到 GitHub 仓库 Settings → Deploy keys
```

### 问题：Docker 构建失败

```bash
# 在服务器上手动构建查看错误
cd /opt/data_processing
docker-compose build --no-cache
```

### 问题：端口被占用

```bash
# 查看端口占用
netstat -tlnp | grep 3000
netstat -tlnp | grep 8000

# 停止占用进程
kill -9 <PID>
```

---

## 安全建议

1. **使用专用部署用户**：不要使用 root，创建专用的 deploy 用户
2. **限制 SSH 密钥权限**：只允许执行部署命令
3. **使用防火墙**：只开放必要端口（22, 3000, 8000）
4. **定期轮换密钥**：定期更新 SSH 密钥和 API 密钥
5. **启用 HTTPS**：生产环境使用 Nginx 反向代理 + SSL 证书

---

## 相关文件

- `.github/workflows/deploy.yml` - GitHub Actions 工作流配置
- `scripts/deploy.sh` - 服务器端部署脚本（可选）
- `docker-compose.yml` - Docker 编排配置
- `env.production.template` - 环境变量模板
